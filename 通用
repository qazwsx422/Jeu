-- åŸºç¡€å¯æ‹–åŠ¨GUI (é˜²å°ç‰ˆ)
local DragGUI = {}

-- é˜²å°æªæ–½
local AntiBan = {
    -- éšæœºåŒ–GUIåç§°
    RandomNames = {"UI_System", "GamePanel", "ControlCenter", "SettingsMenu", "PlayerHUD"},
    -- éšæœºåŒ–é¢œè‰²
    RandomColors = {
        Color3.fromRGB(35, 35, 40),
        Color3.fromRGB(45, 45, 50), 
        Color3.fromRGB(40, 40, 45),
        Color3.fromRGB(50, 50, 55)
    },
    -- å»¶è¿Ÿæ‰§è¡Œ
    DelayExecute = function(callback, minDelay, maxDelay)
        minDelay = minDelay or 0.1
        maxDelay = maxDelay or 0.5
        local delay = math.random(minDelay * 1000, maxDelay * 1000) / 1000
        wait(delay)
        callback()
    end
}

-- å®‰å…¨æ‰§è¡Œå‡½æ•°
function SafeExecute(func, errorMsg)
    local success, result = pcall(func)
    if not success then
        warn("å®‰å…¨æ‰§è¡Œé”™è¯¯: " .. tostring(result))
        return nil
    end
    return result
end

function DragGUI:Create(title)
    -- é˜²å°æªæ–½ï¼šéšæœºåç§°å’Œé¢œè‰²
    local randomName = AntiBan.RandomNames[math.random(1, #AntiBan.RandomNames)]
    local randomColor = AntiBan.RandomColors[math.random(1, #AntiBan.RandomColors)]
    
    -- å®‰å…¨åˆ›å»ºå®ä¾‹
    local function SafeInstance(className, properties)
        return SafeExecute(function()
            local instance = Instance.new(className)
            for prop, value in pairs(properties or {}) do
                instance[prop] = value
            end
            return instance
        end, "åˆ›å»ºå®ä¾‹å¤±è´¥: " .. className)
    end

    -- åˆ›å»ºä¸»ç•Œé¢
    local ScreenGui = SafeInstance("ScreenGui", {
        Parent = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"),
        Name = randomName,
        ResetOnSpawn = false,  -- é˜²å°ï¼šé‡ç”Ÿæ—¶ä¸é‡ç½®
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    })
    
    if not ScreenGui then return nil end

    -- ä¸»æ¡†æ¶
    local MainFrame = SafeInstance("Frame", {
        Parent = ScreenGui,
        Size = UDim2.new(0, 300, 0, 400),
        Position = UDim2.new(0.5, -150, 0.5, -200),
        BackgroundColor3 = randomColor,
        BorderSizePixel = 0,
        ClipsDescendants = true
    })
    
    -- åœ†è§’ (æ›´è‡ªç„¶çš„å¤–è§‚)
    local corner = SafeInstance("UICorner", {
        Parent = MainFrame,
        CornerRadius = UDim.new(0, 8)
    })
    
    -- è½»å¾®é˜´å½±æ•ˆæœ (æ›´åƒæ¸¸æˆåŸç”ŸUI)
    local uiStroke = SafeInstance("UIStroke", {
        Parent = MainFrame,
        Color = Color3.fromRGB(20, 20, 20),
        Thickness = 1
    })

    -- é¡¶éƒ¨æ ï¼ˆå¯æ‹–åŠ¨åŒºåŸŸï¼‰
    local TopBar = SafeInstance("Frame", {
        Parent = MainFrame,
        Size = UDim2.new(1, 0, 0, 30),
        BackgroundColor3 = Color3.fromRGB(25, 25, 30),
        BorderSizePixel = 0
    })
    
    local topCorner = SafeInstance("UICorner", {
        Parent = TopBar,
        CornerRadius = UDim.new(0, 8)
    })

    -- æ ‡é¢˜
    local Title = SafeInstance("TextLabel", {
        Parent = TopBar,
        Size = UDim2.new(1, -60, 1, 0),
        Position = UDim2.new(0, 10, 0, 0),
        BackgroundTransparency = 1,
        Text = title or "ç³»ç»Ÿé¢æ¿",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Font = Enum.Font.Gotham
    })

    -- å…³é—­æŒ‰é’® (æ›´è‡ªç„¶çš„æ ·å¼)
    local CloseBtn = SafeInstance("TextButton", {
        Parent = TopBar,
        Size = UDim2.new(0, 25, 0, 25),
        Position = UDim2.new(1, -30, 0, 2),
        BackgroundColor3 = Color3.fromRGB(80, 80, 90),
        BorderSizePixel = 0,
        Text = "Ã—",
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextSize = 16,
        Font = Enum.Font.GothamBold
    })
    
    local closeCorner = SafeInstance("UICorner", {
        Parent = CloseBtn,
        CornerRadius = UDim.new(0, 4)
    })

    -- å†…å®¹åŒºåŸŸ
    local Content = SafeInstance("Frame", {
        Parent = MainFrame,
        Size = UDim2.new(1, 0, 1, -30),
        Position = UDim2.new(0, 0, 0, 30),
        BackgroundColor3 = Color3.fromRGB(45, 45, 50),
        BorderSizePixel = 0
    })
    
    local contentCorner = SafeInstance("UICorner", {
        Parent = Content,
        CornerRadius = UDim.new(0, 8)
    })

    -- å®‰å…¨çš„æ‹–åŠ¨åŠŸèƒ½
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function update(input)
        SafeExecute(function()
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X, 
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end, "æ‹–åŠ¨æ›´æ–°å¤±è´¥")
    end

    -- é˜²å°ï¼šå»¶è¿Ÿç»‘å®šäº‹ä»¶
    AntiBan.DelayExecute(function()
        SafeExecute(function()
            TopBar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    dragStart = input.Position
                    startPos = MainFrame.Position
                    
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            dragging = false
                        end
                    end)
                end
            end)
            
            TopBar.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
                    dragInput = input
                end
            end)
            
            game:GetService("UserInputService").InputChanged:Connect(function(input)
                if input == dragInput and dragging then
                    update(input)
                end
            end)
        end, "æ‹–åŠ¨äº‹ä»¶ç»‘å®šå¤±è´¥")
    end)

    -- å®‰å…¨çš„å…³é—­åŠŸèƒ½
    CloseBtn.MouseButton1Click:Connect(function()
        AntiBan.DelayExecute(function()
            SafeExecute(function()
                -- æ·¡å‡ºåŠ¨ç”»
                for i = 1, 0, -0.1 do
                    MainFrame.BackgroundTransparency = i
                    wait(0.01)
                end
                ScreenGui:Destroy()
            end, "å…³é—­GUIå¤±è´¥")
        end, 0, 0.1)
    end)

    -- æ‚¬åœæ•ˆæœ (æ›´åƒåŸç”ŸUI)
    CloseBtn.MouseEnter:Connect(function()
        SafeExecute(function()
            game:GetService("TweenService"):Create(CloseBtn, TweenInfo.new(0.2), {
                BackgroundColor3 = Color3.fromRGB(220, 60, 60)
            }):Play()
        end)
    end)
    
    CloseBtn.MouseLeave:Connect(function()
        SafeExecute(function()
            game:GetService("TweenService"):Create(CloseBtn, TweenInfo.new(0.2), {
                BackgroundColor3 = Color3.fromRGB(80, 80, 90)
            }):Play()
        end)
    end)

    return Content
end

-- å®‰å…¨åŠ è½½è„šæœ¬å‡½æ•°
function SafeLoadScript(url)
    AntiBan.DelayExecute(function()
        SafeExecute(function()
            -- æ£€æŸ¥URLå®‰å…¨æ€§
            if not string.find(url, "^https://") then
                warn("ä¸å®‰å…¨çš„URL: " .. url)
                return
            end
            
            print("ğŸ”’ å®‰å…¨åŠ è½½ä¸­...")
            local content = game:HttpGet(url, true)
            
            -- æ£€æŸ¥å†…å®¹é•¿åº¦
            if #content < 10 then
                warn("è„šæœ¬å†…å®¹è¿‡çŸ­ï¼Œå¯èƒ½æ— æ•ˆ")
                return
            end
            
            -- å®‰å…¨æ‰§è¡Œ
            local fn, err = loadstring(content)
            if fn then
                local success, result = pcall(fn)
                if success then
                    print("âœ… è„šæœ¬åŠ è½½æˆåŠŸ!")
                else
                    warn("âŒ è„šæœ¬æ‰§è¡Œé”™è¯¯: " .. tostring(result))
                end
            else
                warn("âŒ è„šæœ¬ç¼–è¯‘é”™è¯¯: " .. tostring(err))
            end
        end, "åŠ è½½è„šæœ¬å¤±è´¥")
    end, 0.2, 0.5)
end

-- ä½¿ç”¨ç¤ºä¾‹
AntiBan.DelayExecute(function()
    local content = DragGUI:Create("ç³»ç»Ÿæ§åˆ¶é¢æ¿")
    
    if content then
        -- å®‰å…¨åˆ›å»ºæŒ‰é’®
        local loadScriptBtn = SafeInstance("TextButton", {
            Parent = content,
            Size = UDim2.new(0, 200, 0, 40),
            Position = UDim2.new(0.5, -100, 0.3, 0),
            BackgroundColor3 = Color3.fromRGB(0, 100, 200),
            BorderSizePixel = 0,
            Text = "åŠ è½½åŠŸèƒ½è„šæœ¬",
            TextColor3 = Color3.fromRGB(255, 255, 255),
            TextSize = 14,
            Font = Enum.Font.Gotham
        })
        
        if loadScriptBtn then
            local btnCorner = SafeInstance("UICorner", {
                Parent = loadScriptBtn,
                CornerRadius = UDim.new(0, 6)
            })
            
            -- æŒ‰é’®æ‚¬åœæ•ˆæœ
            loadScriptBtn.MouseEnter:Connect(function()
                SafeExecute(function()
                    game:GetService("TweenService"):Create(loadScriptBtn, TweenInfo.new(0.2), {
                        BackgroundColor3 = Color3.fromRGB(0, 120, 240)
                    }):Play()
                end)
            end)
            
            loadScriptBtn.MouseLeave:Connect(function()
                SafeExecute(function()
                    game:GetService("TweenService"):Create(loadScriptBtn, TweenInfo.new(0.2), {
                        BackgroundColor3 = Color3.fromRGB(0, 100, 200)
                    }):Play()
                end)
            end)
            
            -- å®‰å…¨åŠ è½½è„šæœ¬
            loadScriptBtn.MouseButton1Click:Connect(function()
                SafeLoadScript("https://pastebin.com/raw/Up3P2KBp")
            end)
        end
        
        print("ğŸ® å®‰å…¨GUIå·²åŠ è½½å®Œæˆ")
    end
end)
